<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaSports - Admin Usuários</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<header class="header">
    <div class="container header-content">
        <a th:href="@{/}" class="logo">
            <img th:src="@{/images/Logo.png}" alt="AlphaSports">
        </a>
        <div class="search-bar">
            <input type="text" placeholder="Buscar produtos..." id="searchInput">
            <button class="search-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            </button>
        </div>
        <nav class="header-nav">
            <div class="nav-link user-dropdown-container" id="userInfo">
                <a th:href="@{/login}" class="nav-link user-link" id="userLink">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span id="userName">Entrar</span>
                </a>
            </div>
            <a th:href="@{/carrinho}" class="nav-link cart-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path></svg>
                <span>Carrinho</span>
                <span class="cart-count" id="cartCount">0</span>
            </a>
            <a href="#" onclick="fazerLogout(event)"  class="nav-link cart-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                Sair
            </a>
        </nav>
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg>
        </button>
    </div>
    <nav class="categories-nav">
        <div class="container">
            <ul class="categories-list">
                <li><a th:href="@{/produtos(categoria=todos)}">Todos</a></li>
                <li><a th:href="@{/produtos(categoria=calcados)}">Calçados</a></li>
                <li><a th:href="@{/produtos(categoria=roupas)}">Roupas</a></li>
                <li><a th:href="@{/produtos(categoria=equipamentos)}">Equipamentos</a></li>
                <li><a th:href="@{/produtos(categoria=futebol)}">Futebol</a></li>
                <li><a th:href="@{/produtos(categoria=corrida)}">Corrida</a></li>
                <li><a th:href="@{/produtos(categoria=fitness)}">Fitness</a></li>
                <li><a th:href="@{/produtos}" class="promo-link">Promoções</a></li>
            </ul>
        </div>
    </nav>
</header>
<div class="perfil-wrapper container">
    <aside class="perfil-menu">
        <h3 id="adminTitle">Admin</h3>
        <ul id="adminSidebar">
            <li data-tab="usuarios">Usuários</li>
            <li class="active" data-tab="produtos">Produtos</li>
            <li data-tab="clientes">Clientes</li>
            <li data-tab="clientes">Funcionarios</li>
            <li data-tab="marca">Marca</li>
            <li data-tab="categoria">Categoria</li>
            <li data-tab="estoque">Estoque</li>
        </ul>
    </aside>
    <main class="perfil-content">
        <div class="admin-header-flex">
            <h1>Produtos</h1>

            <div class="admin-header-actions">
                <div class="tab-container">
                    <button class="tab-button active" id="btnAtivo">Produtos Ativos</button>
                    <button class="tab-button" id="btnInativo">Produtos Inativos</button>
                </div>

                <button class="btn-primary" id="btnAdicionar">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
        </div>

        <div class="card">
            <div id="containerAtivos">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>NOME</th>
                        <th>MARCA</th>
                        <th>CATEGORIA</th>
                        <th>PREÇO</th>
                        <th>Status</th>
                        <th style="text-align: right;">AÇÕES</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${ListaAtivos}">
                        <td style="font-weight: 600;" th:text="${p.nome}"></td>
                        <td th:text="${p.marca}"></td>
                        <td><span class="badge-categoria" th:text="${p.categoria}"></span></td>
                        <td style="font-weight: 600; color: #10b981;">
                            R$ <span th:text="${#numbers.formatDecimal(p.preco, 1, 'POINT', 2, 'COMMA')}">0,00</span>
                        </td>
                        <td th:class="${p.ativo} ? 'ativo' : 'inativo'"
                            th:text="${p.ativo} ? 'Ativo' : 'Inativo'">Status</td>
                        <td class="actions-cell">
                            <button type="button" class="btn-action edit" th:onclick="'abrirModalEdicao(' + ${p.id} + ')'"><i class="fas fa-pencil-alt"></i></button>
                            <a th:href="@{/admin/desativar/{id}(id=${p.id})}" class="btn-action delete" onclick="return confirm('Desativar?')"><i class="fas fa-trash-alt"></i></a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div id="containerInativos" style="display: none;">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>NOME</th>
                        <th>MARCA</th>
                        <th>CATEGORIA</th>
                        <th>PREÇO</th>
                        <th>Status</th>
                        <th style="text-align: right;">AÇÕES</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p : ${ListaInativos}">
                        <td style="font-weight: 600;" th:text="${p.nome}"></td>
                        <td th:text="${p.marca}"></td>
                        <td><span class="badge-categoria" th:text="${p.categoria}">Categoria</span></td>
                        <td style="font-weight: 600; color: #10b981;">
                            R$ <span th:text="${#numbers.formatDecimal(p.preco, 1, 'POINT', 2, 'COMMA')}">0,00</span></td>
                        <td th:class="${p.ativo} ? 'ativo' : 'inativo'"
                            th:text="${p.ativo} ? 'Ativo' : 'Inativo'">Status</td>
                        <td class="actions-cell">
                            <a th:href="@{/admin/ativar/{id}(id=${p.id})}" class="btn-action edit">
                                <i class="fas fa-undo"></i>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    <div class="modal-overlay" id="modalProduto">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Adicionar Novo Produto</h2>
                <button class="modal-close" id="fecharModal">&times;</button>
            </div>
            <form class="modal-form" id="formProduto">
                <input type="hidden" id="produtoId">
                <label>Nome do Produto <span class="required"> * </span> </label>
                <input type="text" id="nomeProd" class="required-field" placeholder="Ex: Camiseta Nike">
                <div class="form-row">
                    <div>
                        <label>Marca <span class="required">*</span> </label>
                        <select id="marcaProd" class="required-field">
                            <option value="">Selecione uma marca</option>
                            <option value="Nike">Nike</option>
                            <option value="Adidas">Adidas</option>
                            <option value="Puma">Puma</option>
                        </select>
                    </div>
                    <div>
                        <label>Categoria <span class="required">*</span> </label>
                        <select id="categoriaProd" class="required-field">
                            <option value="">Selecione uma categoria</option>
                            <option value="Calçados">Calçados</option>
                            <option value="Roupas">Roupas</option>
                            <option value="Equipamentos">Equipamentos</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Preço (R$)<span class="required">*</span> </label>
                        <input type="number" id="precoProd" class="required-field" min="0" step="0.01">
                    </div>
                    <div>
                        <label>Desconto (%)</label>
                        <input type="number" id="descontoProd" min="0" value="0">
                    </div>
                </div>
                <label>Descrição </label>
                <textarea id="descricaoProd" placeholder="Descreva o produto..."></textarea>
                <label>URL da Imagem</label>
                <input type="text" id="imageUrlInput" placeholder="https://exemplo.com/imagem.jpg">
                <label>Ou envie uma imagem</label>
                <div class="upload-box">
                    <input type="file" id="imageFileInput" accept="image/png, image/jpeg">
                    <span>Selecionar imagem (PNG ou JPG)</span>
                </div>
                <div class="image-preview" id="imagePreview">
                    <span>Prévia da imagem</span>
                </div>
                <label>Tamanhos<span class="required">*</span> </label>
                <input type="text" id="tamanhosProd" class="required-field" placeholder="P, M, G, GG">
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelarModal">Cancelar</button>
                    <button type="submit" class="btn-primary" id="btnSalvar">Adicionar Produto</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        const modal = document.getElementById('modalProduto');
        const btnAdicionar = document.getElementById('btnAdicionar');
        const fecharModal = document.getElementById('fecharModal');
        const cancelarModal = document.getElementById('cancelarModal');
        const formProduto = document.getElementById('formProduto');
        const modalTitle = document.getElementById('modalTitle');
        const btnSalvar = document.getElementById('btnSalvar');

        btnAdicionar.addEventListener('click', () => {
            formProduto.reset();
            document.getElementById('produtoId').value = '';
            modalTitle.textContent = "Adicionar Novo Produto";
            btnSalvar.textContent = "Adicionar Produto";
            resetPreview();
            modal.style.display = 'flex';
        });
        async function abrirModalEdicao(id) {
            console.log("Iniciando edição do ID:", id);
            try {
                const response = await fetch(`/admin/api/detalhes/${id}`);
                if (!response.ok) throw new Error(`Erro: ${response.status}`);
                const p = await response.json();
                console.log("Dados recebidos:", p);
                formProduto.reset();
                document.getElementById('produtoId').value = p.id;
                document.getElementById('nomeProd').value = p.nome || '';
                document.getElementById('precoProd').value = p.preco || '';
                document.getElementById('descontoProd').value = p.desconto || 0;
                document.getElementById('descricaoProd').value = p.descricao || '';
                document.getElementById('tamanhosProd').value = p.tamanhos || '';
                document.getElementById('marcaProd').value = p.marca || '';
                document.getElementById('categoriaProd').value = p.categoria || '';
                resetPreview();
                if (p.imagem) {
                    const urlCompleta = p.imagem.startsWith('http') ? p.imagem : '/images/' + p.imagem;
                    document.getElementById('imageUrlInput').value = p.imagem;
                    document.getElementById('imagePreview').innerHTML = `
                <img src="${urlCompleta}"
                     style="max-width:100%; max-height:200px; border-radius: 8px; display: block; margin: auto;">`;
                }
                modalTitle.textContent = "Editar Produto";
                btnSalvar.textContent = "Salvar Alterações";
                modal.style.display = 'flex';
            } catch (error) {
                console.error("Erro ao carregar modal:", error);
            }
        }
        fecharModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        cancelarModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        document.addEventListener("DOMContentLoaded", function() {
            const btnAtivo = document.getElementById("btnAtivo");
            const btnInativo = document.getElementById("btnInativo");
            const containerAtivos = document.getElementById("containerAtivos");
            const containerInativos = document.getElementById("containerInativos");
            if(btnAtivo && btnInativo) {
                btnInativo.addEventListener("click", function() {
                    btnInativo.classList.add("active");
                    btnAtivo.classList.remove("active");
                    containerInativos.style.display = "block";
                    containerAtivos.style.display = "none";
                });
                btnAtivo.addEventListener("click", function() {
                    btnAtivo.classList.add("active");
                    btnInativo.classList.remove("active");
                    containerAtivos.style.display = "block";
                    containerInativos.style.display = "none";
                });
            }
        });
        const imageFileInput = document.getElementById('imageFileInput');
        const imageUrlInput = document.getElementById('imageUrlInput');
        const imagePreview = document.getElementById('imagePreview');
        imageFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.innerHTML = `<img src="${event.target.result}">`;
                    imageUrlInput.value = '';
                };
                reader.readAsDataURL(file);
            }
        });
        imageUrlInput.addEventListener('input', (e) => {
            const url = e.target.value;
            if (url.startsWith('http')) {
                imagePreview.innerHTML = `<img src="${url}">`;
            }
        });
        function resetPreview() {
            imagePreview.innerHTML = `<span>Prévia da imagem</span>`;
            imageFileInput.value = '';
            imageUrlInput.value = '';
        }
        async function atualizarHeader() {
            try {
                const response = await fetch(`/api/auth/verificar`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.cargo !== 'ADMINISTRADOR' && data.role !== 'ADMIN') {
                        window.location.href = '/';
                        return;
                    }
                    const userName = document.getElementById('userName');
                    const adminTitle = document.getElementById('adminTitle');
                    const userLink = document.getElementById('userLink');
                    const primeiroNome = data.nome ? data.nome.split(' ')[0] : "Admin";
                    if (userName) userName.textContent = `Olá, ${primeiroNome}`;
                    if (adminTitle) adminTitle.textContent = `Admin: ${primeiroNome}`;
                    userLink.onclick = (event) => {
                        event.preventDefault();
                        if (data.cargo === 'ADMINISTRADOR' || data.role === 'ADMIN') {
                            window.location.href = '/admin';
                        } else {
                            window.location.href = '/perfil';
                        }
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
            }
        }
        async function fazerLogout(event) {
            event.preventDefault();
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    localStorage.removeItem('alphasports_user');
                    if (typeof showToast === 'function') {
                        showToast('Logout realizado com sucesso!', 'success');
                    }
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                }
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }
        atualizarHeader();
        async function excluirProduto(id) {
            if (!confirm('Deseja excluir este produto?')) return;
            try {
                const response = await fetch(`/api/produtos/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (response.ok) carregarProdutos();
            } catch (error) {
                console.error('Erro ao excluir:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            atualizarHeader();
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll("#adminTableBody tr");
                    rows.forEach(row => {
                        row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
                    });
                });
            }
        });
        formProduto.addEventListener('submit', (e) => {
            e.preventDefault();
            let valido = true;
            const camposObrigatorios = formProduto.querySelectorAll('.required-field');
            camposObrigatorios.forEach(campo => {
                campo.classList.remove('input-error');
                if (
                    campo.value === '' ||
                    campo.value === null ||
                    campo.value.trim() === ''
                ) {
                    campo.classList.add('input-error');
                    valido = false;
                }
            });
            if (
                imageFileInput.files.length === 0 &&
                imageUrlInput.value.trim() === ''
            ) {
                alert('Informe uma imagem (URL ou upload)');
                valido = false;
            }
            if (!valido) {
                alert('Preencha todos os campos obrigatórios (*)');
                return;
            }
            const id = document.getElementById('produtoId').value;
            alert(id ? 'Salvando alterações do produto ID: ' + id : 'Adicionando novo produto...');
        });
    </script>
</body>
</html>